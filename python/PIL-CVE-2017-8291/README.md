# Python PIL Remote Command Execution Vulnerability (GhostButt )

The PIL (Pillow) module that handles images in Python is affected by the GhostButt vulnerability (CVE-2017-8291) because it internally calls GhostScript, causing a remote command execution vulnerability.

Vulnerability details:

 - http://blog.neargle.com/2017/09/28/Exploiting-Python-PIL-Module-Command-Execution-Vulnerability/

## Vulnerability brief

The PIL internally determines the picture type according to the picture header (Magic Bytes). If it finds an eps file (header is `%!PS`), it is distributed to `PIL/EpsImagePlugin.py`.

In this module, PIL calls the system's gs command, which is GhostScript to process the image file:

```python
Command = ["gs",
            "-q", # quiet mode
            "-g%dx%d" % size, # set output geometry (pixels)
            "-r%fx%f" % res, # set input DPI (dots per inch)
            "-dBATCH", # exit after processing
            "-dNOPAUSE", # don't pause between pages,
            "-dSAFER", # safe mode
            "-sDEVICE=ppmraw", # ppm driver
            "-sOutputFile=%s" % outfile, # output file
            "-c", "%d %d translate" % (-bbox[0], -bbox[1]),
                                            # adjust for image origin
            "-f", infile, # input file
            ]

# omitting the code to determine if GhostScript is installed
Try:
    With open(os.devnull, 'w+b') as devnull:
        Subprocess.check_call(command, stdin=devnull, stdout=devnull)
    Im = Image.open(outfile)
```

Although `-dSAFER` is set, which is safe mode, but because of a sandbox bypass vulnerability (GhostButt CVE-2017-8291) of GhostScript, this safe mode is bypassed and any command can be executed.

In addition, as of now, the latest version of GhostScript 9.21 is still affected by this vulnerability, so it can be said that as long as GhostScript is installed on the operating system, our PIL has a command execution vulnerability.

## Vulnerability Testing

Operating environment:

```
Docker-compose build
Docker-compose up -d
```

After running, visit `http://your-ip:8000/` to see an upload page. The normal function is that we upload a PNG file, the backend calls PIL to load the image, and the output length and width. But we can change the executable file EPS file suffix to PNG for uploading, because the backend is to judge the image type according to the file header, so the suffix check is ignored.

For example, [poc.png](poc.png), we upload it, you can execute `touch /tmp/aaaaa`. Change the command in the POC to a bounce command to get the shell:

![](01.png)