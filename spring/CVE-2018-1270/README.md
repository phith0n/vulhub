# Spring Messaging Remote Command Execution Vulnerability (CVE-2018-1270)

Spring messaging provides message support for the spring framework, the upper layer protocol is STOMP, and the underlying communication is based on SockJS.

In spring messaging, it allows clients to subscribe to messages and use selectors to filter messages. The selector is written in a SpEL expression and parsed using `StandardEvaluationContext`, causing a command execution vulnerability.

Reference link:

- https://pivotal.io/security/cve-2018-1270
- https://xz.aliyun.com/t/2252
- https://cert.360.cn/warning/detail?id=3efa573a1116c8e6eed3b47f78723f12
- https://github.com/CaledoniaProject/CVE-2018-1270

## vulnerability environment

Run the following command to start the vulnerability environment:

```
Docker-compose up -d
```

After the environment is started, you can see a web page by visiting `http://your-ip:8080`.

## Vulnerability recurrence

Most articles on the Internet say that spring messaging is based on websocket communication, but it is not. Spring messaging is based on sockjs (which can be understood as a communication protocol), while sockjs adapts to multiple browsers: websocket communication is used in modern browsers, and ajax communication is used in older browsers.

The process of connecting to the backend server can be understood as:

1. Combine data into a text stream using [STOMP Protocol] (http://jmesnil.net/stomp-websocket/doc/)
2. Send the text stream with [sockjs protocol] (https://github.com/sockjs/sockjs-client), sockjs will choose a suitable channel: websocket or xhr(http), communicate with the backend

So we can use http to reproduce the vulnerability, which is called "dimension reduction strike".

I wrote a simple POC script [exploit.py](exploit.py) (which needs to be executed in python 3.6) because the vulnerability is that a SpEL expression is inserted at the time of the subscription and is triggered when a message is sent to the subscription. , so the information we need to specify is:

1. The base address, in vulhub is `http://your-ip:8080/gs-guide-websocket`
2. The SpEL expression to be executed, such as `T(java.lang.Runtime).getRuntime().exec('touch /tmp/success')`
3. The address of a subscription, such as vulhub: `/topic/greetings`
4. How to trigger this subscription, how to let the backend send a message to this subscription. In vulhub, we can trigger this event by sending a json containing name to `/app/hello`. Of course, it is different in actual combat, so this poc is not universal.

Modify the POC according to your own needs. If it is a vulhub environment, you only need to modify the url in 1.

carried out:

![](1.png)

Go to the container `docker-compose exec spring bash` and see that `/tmp/success` has been successfully created:

![](2.png)