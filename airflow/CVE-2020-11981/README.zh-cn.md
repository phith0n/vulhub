# Airflow 1.10.10 CVE-2020-11981 利用Celery进行命令执行

airflow是一款开源的，分布式任务调度框架，它将一个具有上下级依赖关系的工作流，组装成一个有向无环图。

docker-compose文件由airflow 2.x提供的docker-compose文件修改而来。

Airflow的配置中使用CeleryExecutor进行任务执行，所以命令执行结果需要在CeleryWorker所在容器中进行查看。

由于启动的组件比较多，可能会有点卡，虚拟机使用请准备2G以上的内存。

## 漏洞环境

依次执行如下命令启动airflow 1.10.10

```bash
#初始化数据库
docker-compose run airflow-init initdb
#启动服务
docker-compsoe up -d
```

## 漏洞利用

（其实这个还有默认配置中的各种未授权问题的结合利用）

airflow使用Celery 4.0以上的版本，所以没法通过pickle反序列化漏洞进行利用，但可以通过下发自带启动Task用的`airflow.executors.celery_executor.execute_command`任务来执行任意命令，参数为命令执行中所需要的数组。

漏洞利用脚本`exploit_airflow_celery.py`仅支持在python3下使用,默认执行命令`touch /tmp/airflow_celery_success`

```bash
pip install redis
python exploit_airflow_celery.py [主机IP]
```

查看结果：

```bash
docker-compose logs airflow-worker
```

可以看到如下任务消息：

![image-20210701153205499](README.assets/image-20210701153205499.png)

```bash
docker-compose exec airflow-worker ls -l /tmp
```

可以看到成功创建了文件`airflow_celery_success`

![image-20210701153237894](README.assets/image-20210701153237894.png)

## 参考

https://xz.aliyun.com/t/8037

https://lists.apache.org/thread.html/r7255cf0be3566f23a768e2a04b40fb09e52fcd1872695428ba9afe91%40%3Cusers.airflow.apache.org%3E

https://docs.celeryproject.org/en/stable/userguide/configuration.html

https://www.bookstack.cn/read/celery-3.1.7-zh/8d5b10e3439dbe1f.md#dhfmrk

https://docs.celeryproject.org/en/stable/userguide/calling.html#serializers

https://www.jianshu.com/p/52552c075bc0

https://www.runoob.com/w3cnote/python-redis-intro.html

https://blog.csdn.net/SKI_12/article/details/85015803
