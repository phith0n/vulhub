# Samba Remote Command Execution Vulnerability (CVE-2017-7494)

Running the test environment

```
Docker-compose up -d
```

Samba version: 4.6.3 (this vulnerability was fixed in 4.6.4)

## Principle

Samba allows you to connect to a remote named pipe and call the `is_known_pipename()` function to verify that the pipe name is valid before the connection. In the `is_known_pipename()` function, the special characters in the pipe name are not checked, and the dynamic link library using the name is loaded. This allows an attacker to construct a malicious dynamic link library file and execute arbitrary code.

The exploit conditions required for this vulnerability:

 - Have shared file write permissions, such as: anonymous write, etc.
 - Need to know the physical path of the shared directory

reference:

 - https://www.twistlock.com/2017/06/04/security-alert-new-samba-vulnerability-cve-2017-7494/
 - http://bobao.360.cn/learning/detail/3900.html

## Testing process

After the test environment runs, it listens to port 445. By default, a shared "myshare" is enabled, and the shared directory is `/home/share`, which is readable and writable.

We can try to connect with smbclient (install: `apt install smbclient`) under Linux:

![](02.png)

Successfully connected. When everyone tests, if the connection is not successful, it may be that the domestic operator has sealed 445 ports. It is best to test on the VPS. For example, the above picture, I tested locally, and the connection is 127.0.0.1.

Then use metasploit to exploit this vulnerability, first run the latest version of metasploit in Docker:

```
Git clone git@github.com:rapid7/metasploit-framework.git
Cd metasploit-framework
Chmod 0777 $HOME/.msf4/
Docker-compose run --rm --service-ports ms
```

Then select the module `exploit/linux/samba/is_known_pipename`, RHOST is the target IP (the IP of the host running docker), I am here 127.0.0.1.

Note that if you can guess the absolute path to the target writable directory, such as the current test environment, set `set SMB_FOLDER /home/share`. If you can't guess the absolute path in actual combat, then don't set it, msf will automatically blast some paths.

![](01.png)

Successfully got the shell.