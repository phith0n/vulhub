# GIT-SHELL Sandbox Bypass (CVE-2017-8386)

GIT-SHELL sandbox bypass (CVE-2017-8386) caused arbitrary file reads and possible arbitrary command execution vulnerabilities.

Reference link:

 - https://insinuator.net/2017/05/git-shell-bypass-by-abusing-less-cve-2017-8386/
 - https://www.leavesongs.com/PENETRATION/git-shell-cve-2017-8386.html

## test environment

Compile and run the test environment:

```
Docker-compose build
Docker-compose up -d
```

In order not to conflict with the Docker's ssh port, I set the container's ssh port to 3322. In this directory, I generated an `id_rsa`, which is the private key of ssh. Please specify it when connecting.

Before connecting, you need to set the private key to 0600: `chmod 0600 id_rsa`, otherwise the connection may fail.

Normally connect its ssh service `ssh -p 3322 -i id_rsa git@127.0.0.1`, it will be intercepted by git-shell, return error `fatal: unrecognized command ''`, and the connection is closed.

Use the --help trick to connect to the target and go to the help page:

```
Ssh -p 3322 -i id_rsa -t git@127.0.0.1 "git-upload-archive '--help'"
```

Press `shift`+e to read any file:

![](img/03.png)

Go back to the help page and type `!id` to execute the command:

![](img/04.png)

(Why is the www-data user? Because the git user and the www-data user number are both 33, they are actually a user)

## Principle

### git pull process based on ssh protocol

Git-shell is an important part of the git service. As we all know, the git service supports ssh, git, and https to deliver projects. ssh is the safest and most convenient way.

We just open a project on Github and find the address listed in `Clone with SSH`: git@github.com:phith0n/vulhub.git. In fact, this url tells git that the ssh username is git and the address is github.com (The default port is 22), the project is located in the directory `phith0n/vulhub.git`; then git connects to github.com through the ssh protocol and pulls the items in the corresponding directory.

Therefore, operations such as git clone based on the ssh protocol are essentially the process of connecting the git server through the ssh protocol and pulling the specified directory.

So, since this process is a ssh interaction process, then I can directly run `ssh git@github.com` to log in to the github server? Obviously it won't work, you can try:

![](img/01.png)

Saying "no" actually has deviations. In fact, I did connect to its ssh service and verified that the identity passed, but he gave me a message "Hi phith0n! You've recently authenticated, but GitHub does not provide shell Access.", I closed my connection.

So, normally, the ssh-based git pull process is safe for git servers.

For information on how to set up a git server, you can refer to [this article] (http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137583770360579bc4b458f044ce7afed3df579123eca000)

### How to disable git users from executing system shells

So, how do git service providers like github implement the above "secure" communication process?

Let users authenticate their identity through ssh, but don't give the user a shell. There are two ways to do this:

1. Create the system user git and set its shell to git-shell
2. Set the command in front of each ssh-key in the authorized_keys file, overwrite or hijack the original command.

The first method is more intuitive. It is to create a user without giving it a normal bash or sh shell, but to give it a git-shell. Git-shell is a sandboxed environment that allows only the commands contained in the sandbox to be executed under git-shell.

The second method is not only used on git servers, but also in many Linux distributions. For example, aws, root login is not allowed after the default installation. The implementation method is to set `command="echo 'Please login as the user \"ec2-user\" rather than the user \" in /root/.ssh/authorized_keys. Root\".';echo;sleep 10"`. This sentence is equivalent to covering the original implementation of the shell, turned into echo a paragraph of text.

Of course, the second method can also use git-shell, such as giving the normal `/bin/bash` when adding git users, but setting `command="git-shell -c \"$SSH_ORIGINAL_COMMAND in authorized_keys \""`, actually still using git-shell.

### git-shell Sandbox Bypass Vulnerability (CVE-2017-8386)

Git-shell is a shell that restricts the user from executing commands. If we create a new directory in the git user's home directory, call `git-shell-commands`, and then put the commands you allow the user to execute in this directory. I created a sandbox. In git-shell, you can only execute commands in the `/home/git/git-shell-commands` directory.

If the system does not have the `git-shell-commands` directory, git-shell will only allow the following three commands by default:

- `git-receive-pack <argument>`
- `git-upload-pack <argument>`
- `git-upload-archive <argument>`

This is the white list.

But the author of CVE-2017-8386 found that executing `git-upload-archive --help` (or `git-receive-pack --help`) would enter an interactive man page, and man called less The command, and finally a help file that can be paged up and down.

This is nothing, but the less command has a feature that supports some interactive methods. For example, in the less page, press `shift`+e to open the Examine function. You can read any file by this function; you can execute the id command by typing `!id`.

You can just try to find a Linux computer, run `less /etc/passwd` to the less page, and then type `!id` in the English input method to execute the id command:

![](img/02.png)

So, with this feature, we can bypass the git-shell sandbox to read arbitrary files, or execute arbitrary commands!

We can try it first, execute `git-receive-pack --help` directly under Linux, and then type `!id`, and the effect is similar to the above.

[evi1cg big blog] (https://evi1cg.me/archives/CVE-2017-8386.html) has an animation, which is more intuitive.

### Using ssh

So how do you exploit this vulnerability remotely?

We tried before, directly `ssh git@gitserver` can only get git-shell (or return a reminder text), we use the sandbox bypass vulnerability mentioned in the previous section to execute the command:

```
Ssh -p 3322 -i id_rsa -t git@127.0.0.1 "git-upload-archive '--help'"
```

Go to the help page and press shift+e or `!id`.

### Some restrictions

I said earlier, generally configure git users, do not let ssh have a shell, there are two ways: First, set the shell to be `/usr/bin/git-shell` when creating users, and second, override command in authorized_keys.

If the target server uses the first method, we can't execute the command even if we successfully executed `git-upload-archive '--help'` into the help page. Because `!id` is still executed under git-shell, there is no id command in git-shell, so the execution is still unsuccessful.

But reading the file is certainly possible, because the read file is not read by the command, so it is not affected by the git-shell sandbox.

If the target server is a git-shell configured with the second method, such as my test environment here, I set the git user's shell to be bash in the `/etc/passwd` file, and override the command in authorized_keys, execute git- Shell.

In this case, if I enter the help page, enter `!id` to successfully execute the id command, because the id is executed under bash, not under git-shell, so there is no sandbox. limit.

In general, this vulnerability can at least read arbitrary files and it is possible to execute arbitrary commands.