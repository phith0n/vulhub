FROM vulhub/ubuntu:trusty

MAINTAINER phithon <root@leavesongs.com>

ENV GITLAB_VERSION=8.13.1 \
    RUBY_VERSION=2.3 \
    GOLANG_VERSION=1.5.3 \
    GITLAB_SHELL_VERSION=3.6.6 \
    GITLAB_WORKHORSE_VERSION=0.8.5 \
    GITLAB_USER="git" \
    GITLAB_HOME="/home/git" \
    GITLAB_LOG_DIR="/var/log/gitlab" \
    GITLAB_CACHE_DIR="/etc/docker-gitlab" \
    RAILS_ENV=production \
    LOCALPACKAGES_DIR="/packages"

ENV GITLAB_INSTALL_DIR="${GITLAB_HOME}/gitlab" \
    GITLAB_SHELL_INSTALL_DIR="${GITLAB_HOME}/gitlab-shell" \
    GITLAB_WORKHORSE_INSTALL_DIR="${GITLAB_HOME}/gitlab-workhorse" \
    GITLAB_DATA_DIR="${GITLAB_HOME}/data" \
    GITLAB_BUILD_DIR="${GITLAB_CACHE_DIR}/build" \
    GITLAB_RUNTIME_DIR="${GITLAB_CACHE_DIR}/runtime"

RUN echo 'APT::Install-Recommends 0;' >> /etc/apt/apt.conf.d/01norecommends \
 && echo 'APT::Install-Suggests 0;' >> /etc/apt/apt.conf.d/01norecommends \
 && sed -i 's/archive.ubuntu.com/mirrors.ustc.edu.cn/g' /etc/apt/sources.list \
 && apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y vim.tiny wget sudo net-tools ca-certificates unzip apt-transport-https \
 && rm -rf /var/lib/apt/lists/* \
 && mkdir ${LOCALPACKAGES_DIR} \
 && wget -qO- https://gitee.com/leehdsniper/vulhub-package/raw/master/gitlab_packages.tar.gz | tar zx --strip-components 1 -C ${LOCALPACKAGES_DIR} \
 && echo "deb file://${LOCALPACKAGES_DIR}/ git-core/" >> /etc/apt/sources.list \
 && echo "deb file://${LOCALPACKAGES_DIR}/ nginx/" >> /etc/apt/sources.list \
 && echo "deb file://${LOCALPACKAGES_DIR}/ ruby2.3/" >> /etc/apt/sources.list \
 && echo "deb file://${LOCALPACKAGES_DIR}/ ruby2.3-dev/" >> /etc/apt/sources.list \
 && echo "deb file://${LOCALPACKAGES_DIR}/ postgresql-client/" >> /etc/apt/sources.list \
 && apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --force-yes supervisor logrotate locales curl \
      nginx openssh-server mysql-client postgresql-client redis-tools \
      git-core ruby${RUBY_VERSION} python2.7 python-docutils nodejs gettext-base \
      libmysqlclient18 libpq5 zlib1g libyaml-0-2 libssl1.0.0 \
      libgdbm3 libreadline6 libncurses5 libffi6 \
      libxml2 libxslt1.1 libcurl3 libicu52 \
 && update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX \
 && locale-gen en_US.UTF-8 \
 && DEBIAN_FRONTEND=noninteractive dpkg-reconfigure locales \
 && gem install --version '1.14.5' --no-document bundler \
 && rm -rf /var/lib/apt/lists/*

COPY assets/build/ ${GITLAB_BUILD_DIR}/
RUN bash ${GITLAB_BUILD_DIR}/install.sh

COPY assets/runtime/ ${GITLAB_RUNTIME_DIR}/
COPY entrypoint.sh /sbin/entrypoint.sh
RUN chmod 755 /sbin/entrypoint.sh

EXPOSE 22/tcp 80/tcp 443/tcp

VOLUME ["${GITLAB_DATA_DIR}", "${GITLAB_LOG_DIR}"]
WORKDIR ${GITLAB_INSTALL_DIR}
ENTRYPOINT ["/sbin/entrypoint.sh"]
CMD ["app:start"]